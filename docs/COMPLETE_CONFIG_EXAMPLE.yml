# Smart Rate Limiter å®Œæ•´é…ç½®ç¤ºä¾‹
# è¿™æ˜¯ä¸€ä¸ªåŒ…å«æ‰€æœ‰å¯ç”¨é…ç½®é€‰é¡¹çš„å®Œæ•´ç¤ºä¾‹

# ============================================================================
# ğŸ¯ é™æµæ ¸å¿ƒé…ç½® (smart.rate-limiter)
# ============================================================================
smart:
  rate-limiter:
    # æ˜¯å¦å¯ç”¨é™æµåŠŸèƒ½ï¼ˆé»˜è®¤ï¼štrueï¼‰
    enabled: true
    
    # å­˜å‚¨ç±»å‹ï¼šredis(åˆ†å¸ƒå¼), memory(å•æœº), hybrid(æ··åˆ)
    storage-type: hybrid
    
    # é»˜è®¤é™æµç®—æ³•ï¼šsliding-window, fixed-window, token-bucket, leaky-bucket
    default-algorithm: sliding-window
    
    # Keyå‰ç¼€ï¼Œç”¨äºRediså­˜å‚¨
    key-prefix: "smart:rate_limit:"
    
    # æ˜¯å¦åœ¨Keyä¸­åŒ…å«å®Œæ•´æ–¹æ³•ç­¾åï¼ˆé»˜è®¤ï¼šfalseï¼‰
    include-method-signature: true
    
    # å†²çªè§£å†³ç­–ç•¥ï¼šmost-restrictive, least-restrictive, first-discovered, fail-fast
    conflict-strategy: most-restrictive
    
    # ----------------------------------------------------------------------------
    # ğŸš€ æœ¬åœ°ç¼“å­˜é…ç½® - æå‡æ€§èƒ½
    # ----------------------------------------------------------------------------
    cache:
      # æ˜¯å¦å¯ç”¨æœ¬åœ°ç¼“å­˜
      enabled: true
      # ç¼“å­˜æœ€å¤§å¤§å°
      max-size: 10000
      # å†™å…¥åè¿‡æœŸæ—¶é—´ï¼ˆPT1M = 1åˆ†é’Ÿï¼ŒPT5M = 5åˆ†é’Ÿï¼ŒPT1H = 1å°æ—¶ï¼‰
      expire-after-write: PT1M
      # è®¿é—®åè¿‡æœŸæ—¶é—´ï¼ˆæ”¯æŒæ ¼å¼ï¼šPT30S=30ç§’ï¼ŒPT5M=5åˆ†é’Ÿï¼ŒPT1H=1å°æ—¶ï¼ŒPT1D=1å¤©ï¼‰
      expire-after-access: PT5M
      # åˆå§‹å®¹é‡
      initial-capacity: 1000
    
    # ----------------------------------------------------------------------------
    # ğŸ“¦ Rediså­˜å‚¨é…ç½®
    # ----------------------------------------------------------------------------
    redis:
      # Redis Keyå‰ç¼€
      key-prefix: "smart:rate_limit:"
      # Keyåˆ†éš”ç¬¦
      key-separator: ":"
      # Luaè„šæœ¬ç¼“å­˜å¤§å°
      script-cache-size: 100
      # Redisè¿æ¥è¶…æ—¶ï¼ˆPT1S = 1ç§’ï¼‰
      timeout: PT1S
      # æ˜¯å¦ä½¿ç”¨Luaè„šæœ¬ï¼ˆæ¨èï¼‰
      use-lua-scripts: true
      # Redisæ•°æ®åº“ç´¢å¼•
      database: 0
    
    # ----------------------------------------------------------------------------
    # ğŸ’¾ å†…å­˜å­˜å‚¨é…ç½®
    # ----------------------------------------------------------------------------
    memory:
      # å†…å­˜ä¸­æœ€å¤§é™æµè®°å½•æ•°
      max-size: 100000
      # è®°å½•è¿‡æœŸæ—¶é—´ï¼ˆPT10M = 10åˆ†é’Ÿï¼‰
      expire-after-access: PT10M
      # æ¸…ç†è¿‡æœŸè®°å½•çš„é—´éš”ï¼ˆPT1M = 1åˆ†é’Ÿï¼‰
      cleanup-interval: PT1M
    
    # ----------------------------------------------------------------------------
    # ğŸ›¡ï¸ å®¹é”™å’Œé™çº§é…ç½®
    # ----------------------------------------------------------------------------
    fallback:
      # å‡ºé”™æ—¶çš„è¡Œä¸ºï¼šallow(æ”¾è¡Œ), reject(æ‹’ç»)
      on-error: allow
      # Redisä¸å¯ç”¨æ—¶ï¼šmemory(å†…å­˜æ¨¡å¼), allow_all(å…¨éƒ¨æ”¾è¡Œ), reject_all(å…¨éƒ¨æ‹’ç»)
      on-redis-unavailable: memory
      # è§¦å‘é™çº§çš„æœ€å¤§é”™è¯¯æ•°
      max-errors: 5
      # é”™è¯¯æ¢å¤æ£€æŸ¥é—´éš”ï¼ˆPT1M = 1åˆ†é’Ÿï¼‰
      recovery-interval: PT1M
    
    # ----------------------------------------------------------------------------
    # ğŸ“ˆ ç›‘æ§å’ŒæŒ‡æ ‡é…ç½®
    # ----------------------------------------------------------------------------
    monitoring:
      # æ˜¯å¦å¯ç”¨ç›‘æ§æŒ‡æ ‡æ”¶é›†
      enabled: true
      # è¦æ”¶é›†çš„æŒ‡æ ‡ç±»å‹
      metrics:
        - REQUESTS_TOTAL      # æ€»è¯·æ±‚æ•°
        - REQUESTS_ALLOWED    # å…è®¸çš„è¯·æ±‚æ•°
        - REQUESTS_REJECTED   # è¢«æ‹’ç»çš„è¯·æ±‚æ•°
        - CHECK_DURATION      # æ£€æŸ¥è€—æ—¶
        - RATE_LIMIT_STATE    # é™æµçŠ¶æ€
      # æ˜¯å¦åŒ…å«è¯¦ç»†æ ‡ç­¾ï¼ˆç»´åº¦ã€ç®—æ³•ç­‰ï¼‰
      include-detailed-tags: true

# ============================================================================
# ğŸ›ï¸ ç®¡ç†é¡µé¢é…ç½® (rate-limiter.admin)
# ============================================================================
rate-limiter:
  admin:
    # æ˜¯å¦å¯ç”¨ç®¡ç†é¡µé¢
    enabled: true
    # ç®¡ç†é¡µé¢è®¿é—®è·¯å¾„
    base-path: /admin/rate-limiter
    # ç™»å½•ç”¨æˆ·å
    username: admin
    # ç™»å½•å¯†ç ï¼ˆå»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼‰
    password: ${RATE_LIMITER_PASSWORD:admin123}
    # ä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
    session-timeout: 30
    
    # --------------------------------------------------------------------------
    # ğŸ”’ å®‰å…¨é…ç½®
    # --------------------------------------------------------------------------
    security:
      # æ˜¯å¦å¯ç”¨å®‰å…¨å¤´æ£€æŸ¥
      enable-header-check: true
      # è‡ªå®šä¹‰å®‰å…¨å¤´åç§°
      header-name: X-RateLimit-Token
      # è‡ªå®šä¹‰å®‰å…¨å¤´å€¼
      header-value: ${RATE_LIMITER_TOKEN:secure-token-123}
      # IPç™½åå•ï¼ˆCIDRæ ¼å¼ï¼Œé€—å·åˆ†éš”ï¼‰
      allowed-ips: "192.168.0.0/16,10.0.0.0/8,172.16.0.0/12,127.0.0.1"
    
    # --------------------------------------------------------------------------
    # ğŸ” æ¥å£å‘ç°å’Œè¿‡æ»¤é…ç½®
    # --------------------------------------------------------------------------
    discovery:
      # æ˜¯å¦æ’é™¤ç®¡ç†é¡µé¢æœ¬èº«çš„æ¥å£
      exclude-admin-endpoints: true
      # æ˜¯å¦æ’é™¤Spring Boot Actuatorç«¯ç‚¹
      exclude-actuator-endpoints: true
      # æ˜¯å¦æ’é™¤é”™è¯¯å¤„ç†ç«¯ç‚¹
      exclude-error-endpoints: true
      # æ˜¯å¦æ’é™¤é™æ€èµ„æºç«¯ç‚¹
      exclude-static-resource-endpoints: true
      
      # æ’é™¤çš„åŒ…åå‰ç¼€ï¼ˆé€—å·åˆ†éš”ï¼‰
      exclude-packages: |
        org.springframework.boot,
        org.springframework.cloud,
        org.springframework.security,
        com.example.internal,
        com.example.test
      
      # æ’é™¤çš„è·¯å¾„å‰ç¼€ï¼ˆé€—å·åˆ†éš”ï¼‰
      exclude-paths: |
        /favicon.ico,
        /robots.txt,
        /health,
        /metrics,
        /actuator,
        /swagger-ui,
        /api-docs
      
      # æ’é™¤åŒ…å«ç‰¹å®šå…³é”®å­—çš„Controllerï¼ˆé€—å·åˆ†éš”ï¼‰
      exclude-controller-keywords: |
        BasicErrorController,
        ErrorController,
        SwaggerController,
        ActuatorController,
        InternalController
    
    # --------------------------------------------------------------------------
    # ğŸ“ æ“ä½œæ—¥å¿—é…ç½®
    # --------------------------------------------------------------------------
    logging:
      # æ˜¯å¦å¯ç”¨æ–‡ä»¶æ—¥å¿—è¾“å‡º
      file-enabled: true
      # æ—¥å¿—æ–‡ä»¶è·¯å¾„
      file-path: "./logs/rate-limiter/operations.log"
      # æ˜¯å¦ä½¿ç”¨JSONæ ¼å¼
      json-format: true
      # å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§å¤§å°
      max-file-size: "50MB"
      # æ—¥å¿—æ–‡ä»¶ä¿ç•™å¤©æ•°
      max-history: 30
      # æ˜¯å¦å¼‚æ­¥å†™å…¥æ—¥å¿—
      async: true
      # å¼‚æ­¥æ—¥å¿—é˜Ÿåˆ—å¤§å°
      async-queue-size: 2000
      # æ˜¯å¦è®°å½•è¯¦ç»†çš„è¯·æ±‚ä¿¡æ¯
      include-request-details: true
      # æ˜¯å¦è®°å½•é™æµé…ç½®è¯¦æƒ…
      include-config-details: true
      # æ—¥å¿—çº§åˆ«è¿‡æ»¤
      log-level: "INFO"
      # è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼æ¨¡æ¿
      custom-pattern: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    
    # --------------------------------------------------------------------------
    # ğŸ”„ æ¥å£æ‰«æç­–ç•¥é…ç½®
    # --------------------------------------------------------------------------
    scanning:
      # æ‰«æç­–ç•¥ï¼šsync(åŒæ­¥), async(å¼‚æ­¥), disabled(ç¦ç”¨)
      strategy: async
      # å¼‚æ­¥æ‰«æå»¶è¿Ÿå¯åŠ¨æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
      async-delay-minutes: 5
      # å®šæœŸæ‰«æé—´éš”æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
      interval-minutes: 30
      # æ˜¯å¦åœ¨åº”ç”¨å¯åŠ¨æ—¶ç«‹å³æ‰§è¡Œä¸€æ¬¡æ‰«æ
      scan-on-startup: false
      # æ˜¯å¦å¯ç”¨æ™ºèƒ½æ‰«æï¼ˆæ ¹æ®ç³»ç»Ÿè´Ÿè½½è‡ªåŠ¨è°ƒæ•´é¢‘ç‡ï¼‰
      smart-scan: true
      # æ‰«æä»»åŠ¡çº¿ç¨‹æ± å¤§å°
      thread-pool-size: 2
      # å•æ¬¡æ‰«æä»»åŠ¡è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
      timeout-seconds: 60
      # æ˜¯å¦å¯ç”¨æ‰«æç»“æœç¼“å­˜
      enable-cache: true
      # æ‰«æç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
      cache-expire-minutes: 15
      # æœ€å¤§æ‰«ææ·±åº¦ï¼ˆåŒ…å±‚çº§æ•°ï¼‰
      max-scan-depth: 10
      
      # æ’é™¤æ‰«æçš„åŒ…åæ¨¡å¼ï¼ˆæ”¯æŒé€šé…ç¬¦ *ï¼‰
      exclude-packages:
        - "org.springframework.*"
        - "org.apache.*"
        - "com.sun.*"
        - "java.*"
        - "javax.*"
        - "kotlin.*"
        - "scala.*"
        - "groovy.*"
        - "com.example.test.*"
        - "com.example.internal.*"
      
      # åªæ‰«ææŒ‡å®šçš„åŒ…åæ¨¡å¼ï¼ˆç©ºåˆ—è¡¨åˆ™æ‰«ææ‰€æœ‰ï¼Œæ”¯æŒé€šé…ç¬¦ï¼‰
      include-packages:
        - "com.yourcompany.api.*"
        - "com.yourcompany.controller.*"
        - "com.yourcompany.service.*"

# ============================================================================
# ğŸŒŠ Spring Boot ç›¸å…³é…ç½®
# ============================================================================

# Redisé…ç½®ï¼ˆå¦‚æœä½¿ç”¨Rediså­˜å‚¨ï¼‰
spring:
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: ${REDIS_DATABASE:0}
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 20
          max-idle: 10
          min-idle: 2
          max-wait: 2000ms

# æœåŠ¡å™¨é…ç½®
server:
  port: ${SERVER_PORT:8080}
  servlet:
    context-path: ${CONTEXT_PATH:}

# ============================================================================
# ğŸ“Š Spring Boot Actuator ç›‘æ§é…ç½®
# ============================================================================
management:
  endpoints:
    web:
      exposure:
        # æš´éœ²çš„ç›‘æ§ç«¯ç‚¹
        include: health,info,metrics,prometheus,rate-limiter
      # ç›‘æ§ç«¯ç‚¹è·¯å¾„
      base-path: /actuator
  
  endpoint:
    health:
      # æ˜¾ç¤ºå¥åº·æ£€æŸ¥è¯¦æƒ…
      show-details: always
      # å¥åº·æ£€æŸ¥ç»„ä»¶
      show-components: always
    
    # è‡ªå®šä¹‰rate-limiterç›‘æ§ç«¯ç‚¹
    rate-limiter:
      enabled: true
  
  # æŒ‡æ ‡é…ç½®
  metrics:
    export:
      # PrometheusæŒ‡æ ‡å¯¼å‡º
      prometheus:
        enabled: true
        descriptions: true
      # ç®€å•æŒ‡æ ‡å¯¼å‡º
      simple:
        enabled: true
    
    # æŒ‡æ ‡æ ‡ç­¾
    tags:
      application: ${spring.application.name:rate-limiter-app}
      environment: ${ENVIRONMENT:development}
    
    # WebæŒ‡æ ‡
    web:
      server:
        request:
          autotime:
            enabled: true

# ============================================================================
# ğŸ“‹ æ—¥å¿—é…ç½®
# ============================================================================
logging:
  # æ—¥å¿—çº§åˆ«é…ç½®
  level:
    root: INFO
    io.github.rateLimiter: DEBUG
    org.springframework.data.redis: WARN
    
  # æ—¥å¿—æ ¼å¼
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
  
  # æ—¥å¿—æ–‡ä»¶é…ç½®
  file:
    name: "./logs/application.log"
    max-size: "100MB"
    max-history: 30

# ============================================================================
# ğŸ”§ JVMå’Œæ€§èƒ½è°ƒä¼˜é…ç½®
# ============================================================================

# JVMå‚æ•°å»ºè®®ï¼ˆåœ¨å¯åŠ¨è„šæœ¬ä¸­è®¾ç½®ï¼‰
# -Xms512m -Xmx2g
# -XX:+UseG1GC
# -XX:MaxGCPauseMillis=200
# -XX:+PrintGCDetails
# -XX:+PrintGCTimeStamps
# -Dfile.encoding=UTF-8
# -Djava.security.egd=file:/dev/./urandom

# ============================================================================
# ğŸŒ ç¯å¢ƒå˜é‡é…ç½®ç¤ºä¾‹
# ============================================================================

# åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡è¦†ç›–æ•æ„Ÿé…ç½®ï¼š
# export RATE_LIMITER_PASSWORD="your_secure_password_here"
# export RATE_LIMITER_TOKEN="your_secure_token_here"
# export REDIS_HOST="your_redis_host"
# export REDIS_PASSWORD="your_redis_password"
# export SERVER_PORT="8080"
# export ENVIRONMENT="production"

# ============================================================================
# ğŸ“š é…ç½®è¯´æ˜
# ============================================================================

# 1. ç”Ÿäº§ç¯å¢ƒå»ºè®®ï¼š
#    - ä½¿ç”¨ hybrid å­˜å‚¨æ¨¡å¼
#    - å¯ç”¨å¼‚æ­¥æ‰«æï¼Œå»¶è¿Ÿ5åˆ†é’Ÿ
#    - è®¾ç½®å¼ºå¯†ç å’ŒIPç™½åå•
#    - å¯ç”¨æ“ä½œæ—¥å¿—è®°å½•
#    - é…ç½®ç›‘æ§å’Œå‘Šè­¦

# 2. å¼€å‘ç¯å¢ƒå»ºè®®ï¼š
#    - ä½¿ç”¨ memory å­˜å‚¨æ¨¡å¼
#    - å¯ç”¨åŒæ­¥æ‰«æ
#    - ç®€åŒ–å®‰å…¨é…ç½®
#    - è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

# 3. æ€§èƒ½ä¼˜åŒ–å»ºè®®ï¼š
#    - å¯ç”¨æœ¬åœ°ç¼“å­˜
#    - åˆç†è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´
#    - ä½¿ç”¨ Lua è„šæœ¬å‡å°‘ Redis äº¤äº’
#    - é…ç½®åˆé€‚çš„çº¿ç¨‹æ± å¤§å°

# 4. æ—¶é—´æ ¼å¼è¯´æ˜ï¼ˆISO-8601 Durationæ ¼å¼ï¼‰ï¼š
#    - PT30S  = 30ç§’
#    - PT1M   = 1åˆ†é’Ÿ
#    - PT5M   = 5åˆ†é’Ÿ
#    - PT1H   = 1å°æ—¶
#    - PT1D   = 1å¤©
#    - P1W    = 1å‘¨