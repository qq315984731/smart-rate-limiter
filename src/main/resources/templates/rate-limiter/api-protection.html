<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>API保护管理 - Smart Rate Limiter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 {
            color: #333;
            margin: 0;
            font-size: 2.2em;
        }
        .controls {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .search-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .search-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            width: 300px;
        }
        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5a6fd8;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-success:hover {
            background: #219a52;
        }
        .btn-info {
            background: #3498db;
            color: white;
        }
        .btn-info:hover {
            background: #2980b9;
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        .btn-warning:hover {
            background: #e67e22;
        }
        .endpoints-table {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .table-header {
            background: #667eea;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 150px;
            gap: 15px;
            align-items: center;
        }
        .table-row {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 150px;
            gap: 15px;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        .table-row:hover {
            background: #f8f9ff;
        }
        .table-row:last-child {
            border-bottom: none;
        }
        .method-info {
            font-weight: 500;
            color: #333;
        }
        .method-path {
            color: #666;
            font-size: 13px;
            margin-top: 3px;
        }
        .http-method {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 600;
        }
        .http-get { background: #e8f5e8; color: #2e7d32; }
        .http-post { background: #e3f2fd; color: #1976d2; }
        .http-put { background: #fff3e0; color: #f57c00; }
        .http-delete { background: #ffebee; color: #d32f2f; }
        .config-status {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .status-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
        .status-enabled {
            background: #e8f5e8;
            color: #2e7d32;
        }
        .status-disabled {
            background: #f5f5f5;
            color: #666;
        }
        .actions {
            display: flex;
            gap: 5px;
        }
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        .back-link:hover {
            background: rgba(255, 255, 255, 0.3);
            text-decoration: none;
            color: white;
        }
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .empty-state img {
            width: 100px;
            height: 100px;
            opacity: 0.5;
            margin-bottom: 20px;
        }
        .class-name {
            font-size: 12px;
            color: #999;
            margin-top: 2px;
        }
        .method-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 600;
        }
        .method-get { background: #e8f5e8; color: #2e7d32; }
        .method-post { background: #e3f2fd; color: #1976d2; }
        .method-put { background: #fff3e0; color: #f57c00; }
        .method-delete { background: #ffebee; color: #d32f2f; }
        .method-unknown { background: #f5f5f5; color: #666; }
        .text-muted {
            color: #999;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a th:href="${basePath + '/dashboard'}" class="back-link">← 返回限流管理</a>
        
        <div class="header">
            <h1>🔒 API保护管理</h1>
            <p>动态配置幂等性控制和防重复提交策略</p>
        </div>

        <div th:if="${message}" class="alert" th:classappend="${messageType == 'success'} ? 'alert-success' : 'alert-error'">
            <span th:text="${message}"></span>
        </div>

        <!-- 统计信息 -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" style="color: #667eea;" th:text="${endpoints.size()}">0</div>
                <div class="stat-label">总接口数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" style="color: #27ae60;" id="idempotent-count">0</div>
                <div class="stat-label">幂等性配置</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" style="color: #e74c3c;" id="duplicate-count">0</div>
                <div class="stat-label">防重复提交配置</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" style="color: #f39c12;" id="unconfigured-count">0</div>
                <div class="stat-label">未配置</div>
            </div>
        </div>

        <!-- 搜索和过滤 -->
        <div class="controls">
            <div class="search-group">
                <label>搜索接口:</label>
                <input type="text" class="search-input" id="searchInput" placeholder="输入类名、方法名或路径进行搜索..." />
                <button class="btn btn-primary" onclick="searchEndpoints()">搜索</button>
            </div>
            <div class="filter-group">
                <label>过滤:</label>
                <select class="filter-select" id="filterType" onchange="filterEndpoints()">
                    <option value="all">全部接口</option>
                    <option value="idempotent">已配置幂等性</option>
                    <option value="duplicate">已配置防重复提交</option>
                    <option value="unconfigured">未配置</option>
                </select>
            </div>
            <button class="btn btn-info" onclick="refreshData()">刷新数据</button>
        </div>

        <!-- 接口列表 -->
        <div class="endpoints-table">
            <div class="table-header">
                <div>接口信息</div>
                <div>HTTP方法</div>
                <div>幂等性控制</div>
                <div>防重复提交</div>
                <div>状态</div>
                <div>操作</div>
            </div>
            <div id="endpoints-container" class="table-container">
                <div th:each="endpoint : ${endpoints}" class="table-row">
                    <div class="method-info">
                        <div th:text="${endpoint.methodName}">方法名</div>
                        <div class="method-path" th:text="${endpoint.path}">路径</div>
                        <div style="font-size: 12px; color: #999; margin-top: 2px;" th:text="${endpoint.className}">类名</div>
                    </div>
                    <div>
                        <span class="http-method" th:classappend="'http-' + ${endpoint.httpMethod.toLowerCase()}" th:text="${endpoint.httpMethod}">GET</span>
                    </div>
                    <div class="config-status">
                        <span class="status-badge status-disabled" data-endpoint-idempotent th:data-method="${endpoint.methodSignature}">未配置</span>
                    </div>
                    <div class="config-status">
                        <span class="status-badge status-disabled" data-endpoint-duplicate th:data-method="${endpoint.methodSignature}">未配置</span>
                    </div>
                    <div>
                        <span class="status-badge status-disabled" data-endpoint-status th:data-method="${endpoint.methodSignature}">未保护</span>
                    </div>
                    <div class="actions">
                        <button class="btn btn-success btn-sm" th:data-method="${endpoint.methodSignature}" onclick="configureIdempotent(this.dataset.method)">幂等性</button>
                        <button class="btn btn-info btn-sm" th:data-method="${endpoint.methodSignature}" onclick="configureDuplicateSubmit(this.dataset.method)">防重复</button>
                    </div>
                </div>
            </div>
            <div id="empty-state" class="empty-state" style="display: none;">
                <div>📝</div>
                <h3>未找到匹配的接口</h3>
                <p>请尝试调整搜索条件或过滤选项</p>
            </div>
        </div>
    </div>

    <!-- 幂等性配置模态框 -->
    <div id="idempotentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%;">
            <h3>配置幂等性控制</h3>
            <form id="idempotentForm">
                <input type="hidden" id="idempotent-method-signature" />
                <div style="margin-bottom: 15px;">
                    <label>方法签名:</label>
                    <input type="text" id="idempotent-method-display" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;" />
                </div>
                <div style="margin-bottom: 15px;">
                    <label>超时时间(秒):</label>
                    <input type="number" id="idempotent-timeout" value="60" min="1" max="3600" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required />
                    <div style="font-size: 12px; color: #666; margin-top: 3px;">默认60秒，超时后允许重新执行</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label>提示信息:</label>
                    <input type="text" id="idempotent-message" placeholder="操作正在处理中，请勿重复操作" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="idempotent-return-first" checked style="margin: 0;" />
                        返回缓存结果
                    </label>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        勾选：返回第一次请求的结果；不勾选：抛出重复请求异常
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="idempotent-allow-retry" checked style="margin: 0;" />
                        失败后允许重试
                    </label>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        勾选：请求失败后允许重新执行；不勾选：失败后不允许重试
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label>失败检测策略:</label>
                    <select id="idempotent-failure-detection" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" onchange="toggleFailureOptions()">
                        <option value="ALL">所有异常都视为失败（推荐）</option>
                        <option value="RUNTIME_EXCEPTION">仅运行时异常视为失败</option>
                        <option value="SPECIFIC_EXCEPTIONS">仅指定异常类型视为失败</option>
                        <option value="CUSTOM_CONDITION">自定义失败条件</option>
                    </select>
                    <div style="font-size: 12px; color: #666; margin-top: 3px;">定义什么情况下认为请求"失败"</div>
                </div>
                <div id="failure-exceptions-group" style="margin-bottom: 15px; display: none;">
                    <label>失败异常类型:</label>
                    <textarea id="idempotent-failure-exceptions" placeholder="输入异常类名，每行一个，如：&#10;java.util.concurrent.TimeoutException&#10;com.example.BusinessException" style="width: 100%; height: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px;"></textarea>
                    <div style="font-size: 12px; color: #666; margin-top: 3px;">只有这些异常类型才视为失败，其他异常不影响幂等性</div>
                </div>
                <div id="failure-condition-group" style="margin-bottom: 15px; display: none;">
                    <label>失败检测条件:</label>
                    <input type="text" id="idempotent-failure-condition" placeholder="#statusCode >= 500" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;" />
                    <div style="font-size: 12px; color: #666; margin-top: 3px;">
                        SpEL表达式，可用变量：#exception（异常对象）、#statusCode（HTTP状态码）、#response（响应对象）
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-danger" onclick="closeIdempotentModal()">取消</button>
                    <button type="button" class="btn btn-success" onclick="saveIdempotentConfig()">保存</button>
                    <button type="button" class="btn btn-danger" onclick="deleteIdempotentConfig()" id="delete-idempotent-btn" style="display: none;">删除</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 防重复提交配置模态框 -->
    <div id="duplicateModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%;">
            <h3>配置防重复提交</h3>
            <form id="duplicateForm">
                <input type="hidden" id="duplicate-method-signature" />
                <div style="margin-bottom: 15px;">
                    <label>方法签名:</label>
                    <input type="text" id="duplicate-method-display" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;" />
                </div>
                <div style="margin-bottom: 15px;">
                    <label>时间间隔(秒):</label>
                    <input type="number" id="duplicate-interval" value="5" min="1" max="300" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required />
                </div>
                <div style="margin-bottom: 15px;">
                    <label>提示信息:</label>
                    <input type="text" id="duplicate-message" placeholder="请勿重复提交，请稍候再试" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                </div>
                <div style="margin-bottom: 15px;">
                    <label>限制维度:</label>
                    <select id="duplicate-dimension" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="USER_METHOD">用户+方法</option>
                        <option value="IP_METHOD">IP+方法</option>
                        <option value="GLOBAL_METHOD">全局+方法</option>
                        <option value="USER_PARAMS">用户+参数</option>
                        <option value="IP_PARAMS">IP+参数</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-danger" onclick="closeDuplicateModal()">取消</button>
                    <button type="button" class="btn btn-success" onclick="saveDuplicateConfig()">保存</button>
                    <button type="button" class="btn btn-danger" onclick="deleteDuplicateConfig()" id="delete-duplicate-btn" style="display: none;">删除</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let endpoints = [];
        let idempotentConfigs = {};
        let duplicateSubmitConfigs = {};
        const basePath = /*[[${basePath}]]*/ '/admin/rate-limiter';

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            loadEndpoints();
            loadConfigurations();
        });

        // 加载接口列表
        function loadEndpoints() {
            fetch(basePath + '/api/endpoints')
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data)) {
                        endpoints = data;
                        renderEndpointTable();
                    } else {
                        console.error('接口数据格式不正确:', data);
                        endpoints = [];
                    }
                })
                .catch(error => {
                    console.error('加载接口列表失败:', error);
                    // 降级处理：从页面解析现有数据
                    endpoints = Array.from(document.querySelectorAll('.table-row')).map(row => {
                        const methodInfo = row.querySelector('.method-info');
                        if (!methodInfo) return null;
                        
                        const methodName = methodInfo.querySelector('div:first-child')?.textContent || '';
                        const path = methodInfo.querySelector('.method-path')?.textContent || '';
                        const className = methodInfo.querySelector('div:last-child')?.textContent || '';
                        const httpMethodElement = row.querySelector('.http-method');
                        const httpMethod = httpMethodElement?.textContent || '';
                        const methodSignatureElement = row.querySelector('[data-endpoint-idempotent]');
                        const methodSignature = methodSignatureElement?.getAttribute('data-method') || '';
                        
                        return {
                            methodName,
                            path,
                            className,
                            httpMethod,
                            methodSignature,
                            element: row
                        };
                    }).filter(endpoint => endpoint && endpoint.methodSignature);
                });
        }

        // 渲染接口表格
        function renderEndpointTable() {
            // 如果有现有的表格行，先清除  
            const existingRows = document.querySelectorAll('#endpoints-container .table-row');
            existingRows.forEach(row => row.remove());
            
            const container = document.getElementById('endpoints-container');
            if (!container) {
                console.error('未找到endpoints-container容器');
                return;
            }
            
            if (endpoints.length === 0) {
                const emptyState = document.getElementById('empty-state');
                if (emptyState) {
                    emptyState.style.display = 'block';
                }
                return;
            }
            
            endpoints.forEach(endpoint => {
                const hasIdempotent = endpoint.hasIdempotentAnnotation || false;
                const hasDuplicate = endpoint.hasDuplicateSubmitAnnotation || false;
                
                const row = document.createElement('div');
                row.className = 'table-row';
                row.setAttribute('data-method-signature', endpoint.methodSignature);
                
                row.innerHTML = `
                    <div class="method-info">
                        <div><strong>${endpoint.methodName || 'Unknown'}</strong></div>
                        <div class="method-path">${endpoint.path || 'N/A'}</div>
                        <div class="class-name">${endpoint.className || 'Unknown'}</div>
                    </div>
                    <div>
                        <span class="method-badge method-${(endpoint.httpMethod || 'unknown').toLowerCase()}">${endpoint.httpMethod || 'N/A'}</span>
                    </div>
                    <div class="config-status">
                        <span class="status-badge ${hasIdempotent ? 'status-enabled' : 'status-disabled'}" data-endpoint-idempotent data-method="${endpoint.methodSignature}">
                            ${hasIdempotent ? '有注解' : '未配置'}
                        </span>
                    </div>
                    <div class="config-status">
                        <span class="status-badge ${hasDuplicate ? 'status-enabled' : 'status-disabled'}" data-endpoint-duplicate data-method="${endpoint.methodSignature}">
                            ${hasDuplicate ? '有注解' : '未配置'}
                        </span>
                    </div>
                    <div>
                        <span class="status-badge ${hasIdempotent || hasDuplicate ? 'status-enabled' : 'status-disabled'}" data-endpoint-status data-method="${endpoint.methodSignature}">
                            ${hasIdempotent || hasDuplicate ? '有保护' : '未保护'}
                        </span>
                    </div>
                    <div class="actions">
                        <button class="btn btn-success btn-sm" data-idempotent-btn data-method="${endpoint.methodSignature}" onclick="configureIdempotent('${endpoint.methodSignature}')">
                            ${hasIdempotent ? '幂等性' : '配置幂等性'}
                        </button>
                        <button class="btn btn-info btn-sm" data-duplicate-btn data-method="${endpoint.methodSignature}" onclick="configureDuplicateSubmit('${endpoint.methodSignature}')">
                            ${hasDuplicate ? '防重复' : '配置防重复'}
                        </button>
                    </div>
                `;
                
                container.appendChild(row);
            });
        }

        // 加载配置信息
        function loadConfigurations() {
            Promise.all([
                fetch(basePath + '/api/idempotent/list').then(r => r.json()),
                fetch(basePath + '/api/duplicate-submit/list').then(r => r.json())
            ]).then(([idempotentList, duplicateList]) => {
                // 处理幂等性配置
                idempotentConfigs = {};
                idempotentList.forEach(config => {
                    idempotentConfigs[config.methodSignature] = config;
                });

                // 处理防重复提交配置
                duplicateSubmitConfigs = {};
                duplicateList.forEach(config => {
                    duplicateSubmitConfigs[config.methodSignature] = config;
                });

                updateConfigurationStatus();
                updateStatistics();
            }).catch(error => {
                console.error('加载配置失败:', error);
            });
        }

        // 更新配置状态显示
        function updateConfigurationStatus() {
            endpoints.forEach(endpoint => {
                const methodSignature = endpoint.methodSignature;
                
                // 更新幂等性状态
                const idempotentBadge = document.querySelector(`[data-endpoint-idempotent][data-method="${methodSignature}"]`);
                const hasIdempotentConfig = !!idempotentConfigs[methodSignature];
                if (hasIdempotentConfig) {
                    idempotentBadge.textContent = '已配置';
                    idempotentBadge.className = 'status-badge status-enabled';
                } else if (endpoint.hasIdempotentAnnotation) {
                    idempotentBadge.textContent = '有注解';
                    idempotentBadge.className = 'status-badge status-enabled';
                } else {
                    idempotentBadge.textContent = '未配置';
                    idempotentBadge.className = 'status-badge status-disabled';
                }

                // 更新防重复提交状态
                const duplicateBadge = document.querySelector(`[data-endpoint-duplicate][data-method="${methodSignature}"]`);
                const hasDuplicateConfig = !!duplicateSubmitConfigs[methodSignature];
                if (hasDuplicateConfig) {
                    duplicateBadge.textContent = '已配置';
                    duplicateBadge.className = 'status-badge status-enabled';
                } else if (endpoint.hasDuplicateSubmitAnnotation) {
                    duplicateBadge.textContent = '有注解';
                    duplicateBadge.className = 'status-badge status-enabled';
                } else {
                    duplicateBadge.textContent = '未配置';
                    duplicateBadge.className = 'status-badge status-disabled';
                }

                // 更新整体状态
                const statusBadge = document.querySelector(`[data-endpoint-status][data-method="${methodSignature}"]`);
                const hasProtection = hasIdempotentConfig || hasDuplicateConfig || endpoint.hasIdempotentAnnotation || endpoint.hasDuplicateSubmitAnnotation;
                
                if (hasProtection) {
                    statusBadge.textContent = '已保护';
                    statusBadge.className = 'status-badge status-enabled';
                } else {
                    statusBadge.textContent = '未保护';
                    statusBadge.className = 'status-badge status-disabled';
                }

                // 更新按钮状态和文本
                const idempotentBtn = document.querySelector(`[data-idempotent-btn][data-method="${methodSignature}"]`);
                const duplicateBtn = document.querySelector(`[data-duplicate-btn][data-method="${methodSignature}"]`);
                
                if (idempotentBtn) {
                    if (hasIdempotentConfig) {
                        idempotentBtn.textContent = '编辑幂等性';
                        idempotentBtn.className = 'btn btn-warning btn-sm';
                    } else {
                        idempotentBtn.textContent = '配置幂等性';
                        idempotentBtn.className = 'btn btn-success btn-sm';
                    }
                }
                
                if (duplicateBtn) {
                    if (hasDuplicateConfig) {
                        duplicateBtn.textContent = '编辑防重复';
                        duplicateBtn.className = 'btn btn-warning btn-sm';
                    } else {
                        duplicateBtn.textContent = '配置防重复';
                        duplicateBtn.className = 'btn btn-info btn-sm';
                    }
                }
            });
        }

        // 更新统计信息
        function updateStatistics() {
            const totalEndpoints = endpoints.length;
            
            // 计算有幂等性注解或配置的接口数量
            const idempotentCount = endpoints.filter(endpoint => 
                endpoint.hasIdempotentAnnotation || idempotentConfigs[endpoint.methodSignature]
            ).length;
            
            // 计算有防重复提交注解或配置的接口数量  
            const duplicateCount = endpoints.filter(endpoint =>
                endpoint.hasDuplicateSubmitAnnotation || duplicateSubmitConfigs[endpoint.methodSignature]
            ).length;
            
            // 计算未配置保护的接口数量
            const unconfiguredCount = endpoints.filter(endpoint => 
                !endpoint.hasIdempotentAnnotation && 
                !endpoint.hasDuplicateSubmitAnnotation &&
                !idempotentConfigs[endpoint.methodSignature] && 
                !duplicateSubmitConfigs[endpoint.methodSignature]
            ).length;

            // 更新页面显示
            const totalElement = document.querySelector('.stat-card .stat-number');
            if (totalElement) {
                totalElement.textContent = totalEndpoints;
            }
            
            const idempotentElement = document.getElementById('idempotent-count');
            if (idempotentElement) {
                idempotentElement.textContent = idempotentCount;
            }
            
            const duplicateElement = document.getElementById('duplicate-count');
            if (duplicateElement) {
                duplicateElement.textContent = duplicateCount;
            }
            
            const unconfiguredElement = document.getElementById('unconfigured-count');
            if (unconfiguredElement) {
                unconfiguredElement.textContent = unconfiguredCount;
            }
        }

        // 搜索接口
        function searchEndpoints() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            filterAndDisplayEndpoints(keyword);
        }

        // 过滤接口
        function filterEndpoints() {
            const filterType = document.getElementById('filterType').value;
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            filterAndDisplayEndpoints(keyword, filterType);
        }

        // 过滤和显示接口
        function filterAndDisplayEndpoints(keyword = '', filterType = 'all') {
            let visibleCount = 0;
            
            endpoints.forEach(endpoint => {
                const methodSignature = endpoint.methodSignature;
                let shouldShow = true;

                // 关键字过滤
                if (keyword) {
                    const searchText = `${endpoint.methodName || ''} ${endpoint.path || ''} ${endpoint.className || ''} ${endpoint.httpMethod || ''}`.toLowerCase();
                    shouldShow = shouldShow && searchText.includes(keyword);
                }

                // 类型过滤
                if (filterType !== 'all') {
                    const hasIdempotentAnnotation = endpoint.hasIdempotentAnnotation || false;
                    const hasDuplicateAnnotation = endpoint.hasDuplicateSubmitAnnotation || false;
                    const hasIdempotentConfig = !!idempotentConfigs[methodSignature];
                    const hasDuplicateConfig = !!duplicateSubmitConfigs[methodSignature];
                    const hasIdempotent = hasIdempotentAnnotation || hasIdempotentConfig;
                    const hasDuplicate = hasDuplicateAnnotation || hasDuplicateConfig;
                    
                    switch (filterType) {
                        case '已配置幂等性':
                            shouldShow = shouldShow && hasIdempotent;
                            break;
                        case '已配置防重复':
                            shouldShow = shouldShow && hasDuplicate;
                            break;
                        case '未配置':
                            shouldShow = shouldShow && !hasIdempotent && !hasDuplicate;
                            break;
                    }
                }

                // 显示/隐藏对应的行
                const row = document.querySelector(`[data-method-signature="${methodSignature}"]`);
                if (row) {
                    row.style.display = shouldShow ? 'flex' : 'none';
                    if (shouldShow) visibleCount++;
                }
            });

            // 显示/隐藏空状态
            const emptyState = document.getElementById('empty-state');
            if (emptyState) {
                emptyState.style.display = visibleCount === 0 ? 'block' : 'none';
            }
        }

        // 刷新数据
        function refreshData() {
            loadEndpoints(); // 这会重新加载接口数据和配置数据
            showAlert('数据已刷新', 'success');
        }

        // 控制失败检测选项的显示/隐藏
        function toggleFailureOptions() {
            const strategy = document.getElementById('idempotent-failure-detection').value;
            const exceptionsGroup = document.getElementById('failure-exceptions-group');
            const conditionGroup = document.getElementById('failure-condition-group');
            
            // 隐藏所有选项
            exceptionsGroup.style.display = 'none';
            conditionGroup.style.display = 'none';
            
            // 根据策略显示对应选项
            if (strategy === 'SPECIFIC_EXCEPTIONS') {
                exceptionsGroup.style.display = 'block';
            } else if (strategy === 'CUSTOM_CONDITION') {
                conditionGroup.style.display = 'block';
            }
        }

        // 配置幂等性
        function configureIdempotent(methodSignature) {
            document.getElementById('idempotent-method-signature').value = methodSignature;
            document.getElementById('idempotent-method-display').value = methodSignature;
            
            const config = idempotentConfigs[methodSignature];
            if (config) {
                document.getElementById('idempotent-timeout').value = config.timeout || 60;
                document.getElementById('idempotent-message').value = config.message || '';
                document.getElementById('idempotent-return-first').checked = config.returnFirstResult !== false;
                document.getElementById('idempotent-allow-retry').checked = config.allowRetryOnFailure !== false;
                document.getElementById('idempotent-failure-detection').value = config.failureDetection || 'ALL';
                document.getElementById('idempotent-failure-exceptions').value = config.failureExceptions || '';
                document.getElementById('idempotent-failure-condition').value = config.failureCondition || '';
                document.getElementById('delete-idempotent-btn').style.display = 'inline-block';
            } else {
                document.getElementById('idempotent-timeout').value = 60;
                document.getElementById('idempotent-message').value = '';
                document.getElementById('idempotent-return-first').checked = true;
                document.getElementById('idempotent-allow-retry').checked = true;
                document.getElementById('idempotent-failure-detection').value = 'ALL';
                document.getElementById('idempotent-failure-exceptions').value = '';
                document.getElementById('idempotent-failure-condition').value = '';
                document.getElementById('delete-idempotent-btn').style.display = 'none';
            }
            
            // 显示对应的失败检测选项
            toggleFailureOptions();
            
            document.getElementById('idempotentModal').style.display = 'block';
        }

        // 配置防重复提交
        function configureDuplicateSubmit(methodSignature) {
            document.getElementById('duplicate-method-signature').value = methodSignature;
            document.getElementById('duplicate-method-display').value = methodSignature;
            
            const config = duplicateSubmitConfigs[methodSignature];
            if (config) {
                document.getElementById('duplicate-interval').value = config.interval || 5;
                document.getElementById('duplicate-message').value = config.message || '';
                document.getElementById('duplicate-dimension').value = config.dimension || 'USER_METHOD';
                document.getElementById('delete-duplicate-btn').style.display = 'inline-block';
            } else {
                document.getElementById('duplicate-interval').value = 5;
                document.getElementById('duplicate-message').value = '';
                document.getElementById('duplicate-dimension').value = 'USER_METHOD';
                document.getElementById('delete-duplicate-btn').style.display = 'none';
            }
            
            document.getElementById('duplicateModal').style.display = 'block';
        }

        // 关闭模态框
        function closeIdempotentModal() {
            document.getElementById('idempotentModal').style.display = 'none';
        }

        function closeDuplicateModal() {
            document.getElementById('duplicateModal').style.display = 'none';
        }

        // 保存幂等性配置
        function saveIdempotentConfig() {
            const methodSignature = document.getElementById('idempotent-method-signature').value;
            const config = {
                methodSignature: methodSignature,
                enabled: true,
                timeout: parseInt(document.getElementById('idempotent-timeout').value),
                keyStrategy: "USER_PARAMS", // 默认使用用户ID+参数的策略（幂等性最佳实践）
                returnFirstResult: document.getElementById('idempotent-return-first').checked,
                message: document.getElementById('idempotent-message').value || "请求正在处理中，请稍候再试",
                allowRetryOnFailure: document.getElementById('idempotent-allow-retry').checked,
                failureDetection: document.getElementById('idempotent-failure-detection').value,
                failureExceptions: document.getElementById('idempotent-failure-exceptions').value,
                failureCondition: document.getElementById('idempotent-failure-condition').value
            };

            fetch('/admin/rate-limiter/api/idempotent/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('幂等性配置保存成功', 'success');
                    closeIdempotentModal();
                    loadConfigurations();
                } else {
                    showAlert('保存失败: ' + data.message, 'error');
                }
            })
            .catch(error => {
                showAlert('保存失败: ' + error.message, 'error');
            });
        }

        // 保存防重复提交配置
        function saveDuplicateConfig() {
            const methodSignature = document.getElementById('duplicate-method-signature').value;
            const config = {
                methodSignature: methodSignature,
                interval: parseInt(document.getElementById('duplicate-interval').value),
                message: document.getElementById('duplicate-message').value,
                dimension: document.getElementById('duplicate-dimension').value
            };

            fetch('/admin/rate-limiter/api/duplicate-submit/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('防重复提交配置保存成功', 'success');
                    closeDuplicateModal();
                    loadConfigurations();
                } else {
                    showAlert('保存失败: ' + data.message, 'error');
                }
            })
            .catch(error => {
                showAlert('保存失败: ' + error.message, 'error');
            });
        }

        // 删除幂等性配置
        function deleteIdempotentConfig() {
            const methodSignature = document.getElementById('idempotent-method-signature').value;
            if (!confirm('确定要删除此幂等性配置吗？')) return;
            
            fetch('/admin/rate-limiter/api/idempotent/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'methodSignature=' + encodeURIComponent(methodSignature)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('删除成功', 'success');
                    closeIdempotentModal();
                    loadConfigurations();
                } else {
                    showAlert('删除失败: ' + data.message, 'error');
                }
            });
        }

        // 删除防重复提交配置
        function deleteDuplicateConfig() {
            const methodSignature = document.getElementById('duplicate-method-signature').value;
            if (!confirm('确定要删除此防重复提交配置吗？')) return;
            
            fetch('/admin/rate-limiter/api/duplicate-submit/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'methodSignature=' + encodeURIComponent(methodSignature)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('删除成功', 'success');
                    closeDuplicateModal();
                    loadConfigurations();
                } else {
                    showAlert('删除失败: ' + data.message, 'error');
                }
            });
        }

        // 显示提示信息
        function showAlert(message, type) {
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            
            document.querySelector('.header').insertAdjacentElement('afterend', alert);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }
    </script>
</body>
</html>