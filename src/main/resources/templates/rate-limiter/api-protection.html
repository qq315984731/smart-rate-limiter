<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>APIä¿æŠ¤ç®¡ç† - Smart Rate Limiter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 {
            color: #333;
            margin: 0;
            font-size: 2.2em;
        }
        .controls {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .search-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .search-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            width: 300px;
        }
        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5a6fd8;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-success:hover {
            background: #219a52;
        }
        .btn-info {
            background: #3498db;
            color: white;
        }
        .btn-info:hover {
            background: #2980b9;
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        .btn-warning:hover {
            background: #e67e22;
        }
        .endpoints-table {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .table-header {
            background: #667eea;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 150px;
            gap: 15px;
            align-items: center;
        }
        .table-row {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 150px;
            gap: 15px;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        .table-row:hover {
            background: #f8f9ff;
        }
        .table-row:last-child {
            border-bottom: none;
        }
        .method-info {
            font-weight: 500;
            color: #333;
        }
        .method-path {
            color: #666;
            font-size: 13px;
            margin-top: 3px;
        }
        .http-method {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 600;
        }
        .http-get { background: #e8f5e8; color: #2e7d32; }
        .http-post { background: #e3f2fd; color: #1976d2; }
        .http-put { background: #fff3e0; color: #f57c00; }
        .http-delete { background: #ffebee; color: #d32f2f; }
        .config-status {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .status-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
        .status-enabled {
            background: #e8f5e8;
            color: #2e7d32;
        }
        .status-disabled {
            background: #f5f5f5;
            color: #666;
        }
        .actions {
            display: flex;
            gap: 5px;
        }
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        .back-link:hover {
            background: rgba(255, 255, 255, 0.3);
            text-decoration: none;
            color: white;
        }
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .empty-state img {
            width: 100px;
            height: 100px;
            opacity: 0.5;
            margin-bottom: 20px;
        }
        .class-name {
            font-size: 12px;
            color: #999;
            margin-top: 2px;
        }
        .method-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 600;
        }
        .method-get { background: #e8f5e8; color: #2e7d32; }
        .method-post { background: #e3f2fd; color: #1976d2; }
        .method-put { background: #fff3e0; color: #f57c00; }
        .method-delete { background: #ffebee; color: #d32f2f; }
        .method-unknown { background: #f5f5f5; color: #666; }
        .text-muted {
            color: #999;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a th:href="${basePath + '/dashboard'}" class="back-link">â† è¿”å›é™æµç®¡ç†</a>
        
        <div class="header">
            <h1>ğŸ”’ APIä¿æŠ¤ç®¡ç†</h1>
            <p>åŠ¨æ€é…ç½®å¹‚ç­‰æ€§æ§åˆ¶å’Œé˜²é‡å¤æäº¤ç­–ç•¥</p>
        </div>

        <div th:if="${message}" class="alert" th:classappend="${messageType == 'success'} ? 'alert-success' : 'alert-error'">
            <span th:text="${message}"></span>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" style="color: #667eea;" th:text="${endpoints.size()}">0</div>
                <div class="stat-label">æ€»æ¥å£æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" style="color: #27ae60;" id="idempotent-count">0</div>
                <div class="stat-label">å¹‚ç­‰æ€§é…ç½®</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" style="color: #e74c3c;" id="duplicate-count">0</div>
                <div class="stat-label">é˜²é‡å¤æäº¤é…ç½®</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" style="color: #f39c12;" id="unconfigured-count">0</div>
                <div class="stat-label">æœªé…ç½®</div>
            </div>
        </div>

        <!-- æœç´¢å’Œè¿‡æ»¤ -->
        <div class="controls">
            <div class="search-group">
                <label>æœç´¢æ¥å£:</label>
                <input type="text" class="search-input" id="searchInput" placeholder="è¾“å…¥ç±»åã€æ–¹æ³•åæˆ–è·¯å¾„è¿›è¡Œæœç´¢..." />
                <button class="btn btn-primary" onclick="searchEndpoints()">æœç´¢</button>
            </div>
            <div class="filter-group">
                <label>è¿‡æ»¤:</label>
                <select class="filter-select" id="filterType" onchange="filterEndpoints()">
                    <option value="all">å…¨éƒ¨æ¥å£</option>
                    <option value="idempotent">å·²é…ç½®å¹‚ç­‰æ€§</option>
                    <option value="duplicate">å·²é…ç½®é˜²é‡å¤æäº¤</option>
                    <option value="unconfigured">æœªé…ç½®</option>
                </select>
            </div>
            <button class="btn btn-info" onclick="refreshData()">åˆ·æ–°æ•°æ®</button>
        </div>

        <!-- æ¥å£åˆ—è¡¨ -->
        <div class="endpoints-table">
            <div class="table-header">
                <div>æ¥å£ä¿¡æ¯</div>
                <div>HTTPæ–¹æ³•</div>
                <div>å¹‚ç­‰æ€§æ§åˆ¶</div>
                <div>é˜²é‡å¤æäº¤</div>
                <div>çŠ¶æ€</div>
                <div>æ“ä½œ</div>
            </div>
            <div id="endpoints-container" class="table-container">
                <div th:each="endpoint : ${endpoints}" class="table-row">
                    <div class="method-info">
                        <div th:text="${endpoint.methodName}">æ–¹æ³•å</div>
                        <div class="method-path" th:text="${endpoint.path}">è·¯å¾„</div>
                        <div style="font-size: 12px; color: #999; margin-top: 2px;" th:text="${endpoint.className}">ç±»å</div>
                    </div>
                    <div>
                        <span class="http-method" th:classappend="'http-' + ${endpoint.httpMethod.toLowerCase()}" th:text="${endpoint.httpMethod}">GET</span>
                    </div>
                    <div class="config-status">
                        <span class="status-badge status-disabled" data-endpoint-idempotent th:data-method="${endpoint.methodSignature}">æœªé…ç½®</span>
                    </div>
                    <div class="config-status">
                        <span class="status-badge status-disabled" data-endpoint-duplicate th:data-method="${endpoint.methodSignature}">æœªé…ç½®</span>
                    </div>
                    <div>
                        <span class="status-badge status-disabled" data-endpoint-status th:data-method="${endpoint.methodSignature}">æœªä¿æŠ¤</span>
                    </div>
                    <div class="actions">
                        <button class="btn btn-success btn-sm" th:data-method="${endpoint.methodSignature}" onclick="configureIdempotent(this.dataset.method)">å¹‚ç­‰æ€§</button>
                        <button class="btn btn-info btn-sm" th:data-method="${endpoint.methodSignature}" onclick="configureDuplicateSubmit(this.dataset.method)">é˜²é‡å¤</button>
                    </div>
                </div>
            </div>
            <div id="empty-state" class="empty-state" style="display: none;">
                <div>ğŸ“</div>
                <h3>æœªæ‰¾åˆ°åŒ¹é…çš„æ¥å£</h3>
                <p>è¯·å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶æˆ–è¿‡æ»¤é€‰é¡¹</p>
            </div>
        </div>
    </div>

    <!-- å¹‚ç­‰æ€§é…ç½®æ¨¡æ€æ¡† -->
    <div id="idempotentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%;">
            <h3>é…ç½®å¹‚ç­‰æ€§æ§åˆ¶</h3>
            <form id="idempotentForm">
                <input type="hidden" id="idempotent-method-signature" />
                <div style="margin-bottom: 15px;">
                    <label>æ–¹æ³•ç­¾å:</label>
                    <input type="text" id="idempotent-method-display" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;" />
                </div>
                <div style="margin-bottom: 15px;">
                    <label>è¶…æ—¶æ—¶é—´(ç§’):</label>
                    <input type="number" id="idempotent-timeout" value="60" min="1" max="3600" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required />
                    <div style="font-size: 12px; color: #666; margin-top: 3px;">é»˜è®¤60ç§’ï¼Œè¶…æ—¶åå…è®¸é‡æ–°æ‰§è¡Œ</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label>æç¤ºä¿¡æ¯:</label>
                    <input type="text" id="idempotent-message" placeholder="æ“ä½œæ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·å‹¿é‡å¤æ“ä½œ" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="idempotent-return-first" checked style="margin: 0;" />
                        è¿”å›ç¼“å­˜ç»“æœ
                    </label>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        å‹¾é€‰ï¼šè¿”å›ç¬¬ä¸€æ¬¡è¯·æ±‚çš„ç»“æœï¼›ä¸å‹¾é€‰ï¼šæŠ›å‡ºé‡å¤è¯·æ±‚å¼‚å¸¸
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="idempotent-allow-retry" checked style="margin: 0;" />
                        å¤±è´¥åå…è®¸é‡è¯•
                    </label>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        å‹¾é€‰ï¼šè¯·æ±‚å¤±è´¥åå…è®¸é‡æ–°æ‰§è¡Œï¼›ä¸å‹¾é€‰ï¼šå¤±è´¥åä¸å…è®¸é‡è¯•
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label>å¤±è´¥æ£€æµ‹ç­–ç•¥:</label>
                    <select id="idempotent-failure-detection" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" onchange="toggleFailureOptions()">
                        <option value="ALL">æ‰€æœ‰å¼‚å¸¸éƒ½è§†ä¸ºå¤±è´¥ï¼ˆæ¨èï¼‰</option>
                        <option value="RUNTIME_EXCEPTION">ä»…è¿è¡Œæ—¶å¼‚å¸¸è§†ä¸ºå¤±è´¥</option>
                        <option value="SPECIFIC_EXCEPTIONS">ä»…æŒ‡å®šå¼‚å¸¸ç±»å‹è§†ä¸ºå¤±è´¥</option>
                        <option value="CUSTOM_CONDITION">è‡ªå®šä¹‰å¤±è´¥æ¡ä»¶</option>
                    </select>
                    <div style="font-size: 12px; color: #666; margin-top: 3px;">å®šä¹‰ä»€ä¹ˆæƒ…å†µä¸‹è®¤ä¸ºè¯·æ±‚"å¤±è´¥"</div>
                </div>
                <div id="failure-exceptions-group" style="margin-bottom: 15px; display: none;">
                    <label>å¤±è´¥å¼‚å¸¸ç±»å‹:</label>
                    <textarea id="idempotent-failure-exceptions" placeholder="è¾“å…¥å¼‚å¸¸ç±»åï¼Œæ¯è¡Œä¸€ä¸ªï¼Œå¦‚ï¼š&#10;java.util.concurrent.TimeoutException&#10;com.example.BusinessException" style="width: 100%; height: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px;"></textarea>
                    <div style="font-size: 12px; color: #666; margin-top: 3px;">åªæœ‰è¿™äº›å¼‚å¸¸ç±»å‹æ‰è§†ä¸ºå¤±è´¥ï¼Œå…¶ä»–å¼‚å¸¸ä¸å½±å“å¹‚ç­‰æ€§</div>
                </div>
                <div id="failure-condition-group" style="margin-bottom: 15px; display: none;">
                    <label>å¤±è´¥æ£€æµ‹æ¡ä»¶:</label>
                    <input type="text" id="idempotent-failure-condition" placeholder="#statusCode >= 500" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;" />
                    <div style="font-size: 12px; color: #666; margin-top: 3px;">
                        SpELè¡¨è¾¾å¼ï¼Œå¯ç”¨å˜é‡ï¼š#exceptionï¼ˆå¼‚å¸¸å¯¹è±¡ï¼‰ã€#statusCodeï¼ˆHTTPçŠ¶æ€ç ï¼‰ã€#responseï¼ˆå“åº”å¯¹è±¡ï¼‰
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-danger" onclick="closeIdempotentModal()">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-success" onclick="saveIdempotentConfig()">ä¿å­˜</button>
                    <button type="button" class="btn btn-danger" onclick="deleteIdempotentConfig()" id="delete-idempotent-btn" style="display: none;">åˆ é™¤</button>
                </div>
            </form>
        </div>
    </div>

    <!-- é˜²é‡å¤æäº¤é…ç½®æ¨¡æ€æ¡† -->
    <div id="duplicateModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%;">
            <h3>é…ç½®é˜²é‡å¤æäº¤</h3>
            <form id="duplicateForm">
                <input type="hidden" id="duplicate-method-signature" />
                <div style="margin-bottom: 15px;">
                    <label>æ–¹æ³•ç­¾å:</label>
                    <input type="text" id="duplicate-method-display" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;" />
                </div>
                <div style="margin-bottom: 15px;">
                    <label>æ—¶é—´é—´éš”(ç§’):</label>
                    <input type="number" id="duplicate-interval" value="5" min="1" max="300" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required />
                </div>
                <div style="margin-bottom: 15px;">
                    <label>æç¤ºä¿¡æ¯:</label>
                    <input type="text" id="duplicate-message" placeholder="è¯·å‹¿é‡å¤æäº¤ï¼Œè¯·ç¨å€™å†è¯•" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                </div>
                <div style="margin-bottom: 15px;">
                    <label>é™åˆ¶ç»´åº¦:</label>
                    <select id="duplicate-dimension" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="USER_METHOD">ç”¨æˆ·+æ–¹æ³•</option>
                        <option value="IP_METHOD">IP+æ–¹æ³•</option>
                        <option value="GLOBAL_METHOD">å…¨å±€+æ–¹æ³•</option>
                        <option value="USER_PARAMS">ç”¨æˆ·+å‚æ•°</option>
                        <option value="IP_PARAMS">IP+å‚æ•°</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-danger" onclick="closeDuplicateModal()">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-success" onclick="saveDuplicateConfig()">ä¿å­˜</button>
                    <button type="button" class="btn btn-danger" onclick="deleteDuplicateConfig()" id="delete-duplicate-btn" style="display: none;">åˆ é™¤</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let endpoints = [];
        let idempotentConfigs = {};
        let duplicateSubmitConfigs = {};
        const basePath = /*[[${basePath}]]*/ '/admin/rate-limiter';

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            loadEndpoints();
            loadConfigurations();
        });

        // åŠ è½½æ¥å£åˆ—è¡¨
        function loadEndpoints() {
            fetch(basePath + '/api/endpoints')
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data)) {
                        endpoints = data;
                        renderEndpointTable();
                    } else {
                        console.error('æ¥å£æ•°æ®æ ¼å¼ä¸æ­£ç¡®:', data);
                        endpoints = [];
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½æ¥å£åˆ—è¡¨å¤±è´¥:', error);
                    // é™çº§å¤„ç†ï¼šä»é¡µé¢è§£æç°æœ‰æ•°æ®
                    endpoints = Array.from(document.querySelectorAll('.table-row')).map(row => {
                        const methodInfo = row.querySelector('.method-info');
                        if (!methodInfo) return null;
                        
                        const methodName = methodInfo.querySelector('div:first-child')?.textContent || '';
                        const path = methodInfo.querySelector('.method-path')?.textContent || '';
                        const className = methodInfo.querySelector('div:last-child')?.textContent || '';
                        const httpMethodElement = row.querySelector('.http-method');
                        const httpMethod = httpMethodElement?.textContent || '';
                        const methodSignatureElement = row.querySelector('[data-endpoint-idempotent]');
                        const methodSignature = methodSignatureElement?.getAttribute('data-method') || '';
                        
                        return {
                            methodName,
                            path,
                            className,
                            httpMethod,
                            methodSignature,
                            element: row
                        };
                    }).filter(endpoint => endpoint && endpoint.methodSignature);
                });
        }

        // æ¸²æŸ“æ¥å£è¡¨æ ¼
        function renderEndpointTable() {
            // å¦‚æœæœ‰ç°æœ‰çš„è¡¨æ ¼è¡Œï¼Œå…ˆæ¸…é™¤  
            const existingRows = document.querySelectorAll('#endpoints-container .table-row');
            existingRows.forEach(row => row.remove());
            
            const container = document.getElementById('endpoints-container');
            if (!container) {
                console.error('æœªæ‰¾åˆ°endpoints-containerå®¹å™¨');
                return;
            }
            
            if (endpoints.length === 0) {
                const emptyState = document.getElementById('empty-state');
                if (emptyState) {
                    emptyState.style.display = 'block';
                }
                return;
            }
            
            endpoints.forEach(endpoint => {
                const hasIdempotent = endpoint.hasIdempotentAnnotation || false;
                const hasDuplicate = endpoint.hasDuplicateSubmitAnnotation || false;
                
                const row = document.createElement('div');
                row.className = 'table-row';
                row.setAttribute('data-method-signature', endpoint.methodSignature);
                
                row.innerHTML = `
                    <div class="method-info">
                        <div><strong>${endpoint.methodName || 'Unknown'}</strong></div>
                        <div class="method-path">${endpoint.path || 'N/A'}</div>
                        <div class="class-name">${endpoint.className || 'Unknown'}</div>
                    </div>
                    <div>
                        <span class="method-badge method-${(endpoint.httpMethod || 'unknown').toLowerCase()}">${endpoint.httpMethod || 'N/A'}</span>
                    </div>
                    <div class="config-status">
                        <span class="status-badge ${hasIdempotent ? 'status-enabled' : 'status-disabled'}" data-endpoint-idempotent data-method="${endpoint.methodSignature}">
                            ${hasIdempotent ? 'æœ‰æ³¨è§£' : 'æœªé…ç½®'}
                        </span>
                    </div>
                    <div class="config-status">
                        <span class="status-badge ${hasDuplicate ? 'status-enabled' : 'status-disabled'}" data-endpoint-duplicate data-method="${endpoint.methodSignature}">
                            ${hasDuplicate ? 'æœ‰æ³¨è§£' : 'æœªé…ç½®'}
                        </span>
                    </div>
                    <div>
                        <span class="status-badge ${hasIdempotent || hasDuplicate ? 'status-enabled' : 'status-disabled'}" data-endpoint-status data-method="${endpoint.methodSignature}">
                            ${hasIdempotent || hasDuplicate ? 'æœ‰ä¿æŠ¤' : 'æœªä¿æŠ¤'}
                        </span>
                    </div>
                    <div class="actions">
                        <button class="btn btn-success btn-sm" data-idempotent-btn data-method="${endpoint.methodSignature}" onclick="configureIdempotent('${endpoint.methodSignature}')">
                            ${hasIdempotent ? 'å¹‚ç­‰æ€§' : 'é…ç½®å¹‚ç­‰æ€§'}
                        </button>
                        <button class="btn btn-info btn-sm" data-duplicate-btn data-method="${endpoint.methodSignature}" onclick="configureDuplicateSubmit('${endpoint.methodSignature}')">
                            ${hasDuplicate ? 'é˜²é‡å¤' : 'é…ç½®é˜²é‡å¤'}
                        </button>
                    </div>
                `;
                
                container.appendChild(row);
            });
        }

        // åŠ è½½é…ç½®ä¿¡æ¯
        function loadConfigurations() {
            Promise.all([
                fetch(basePath + '/api/idempotent/list').then(r => r.json()),
                fetch(basePath + '/api/duplicate-submit/list').then(r => r.json())
            ]).then(([idempotentList, duplicateList]) => {
                // å¤„ç†å¹‚ç­‰æ€§é…ç½®
                idempotentConfigs = {};
                idempotentList.forEach(config => {
                    idempotentConfigs[config.methodSignature] = config;
                });

                // å¤„ç†é˜²é‡å¤æäº¤é…ç½®
                duplicateSubmitConfigs = {};
                duplicateList.forEach(config => {
                    duplicateSubmitConfigs[config.methodSignature] = config;
                });

                updateConfigurationStatus();
                updateStatistics();
            }).catch(error => {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            });
        }

        // æ›´æ–°é…ç½®çŠ¶æ€æ˜¾ç¤º
        function updateConfigurationStatus() {
            endpoints.forEach(endpoint => {
                const methodSignature = endpoint.methodSignature;
                
                // æ›´æ–°å¹‚ç­‰æ€§çŠ¶æ€
                const idempotentBadge = document.querySelector(`[data-endpoint-idempotent][data-method="${methodSignature}"]`);
                const hasIdempotentConfig = !!idempotentConfigs[methodSignature];
                if (hasIdempotentConfig) {
                    idempotentBadge.textContent = 'å·²é…ç½®';
                    idempotentBadge.className = 'status-badge status-enabled';
                } else if (endpoint.hasIdempotentAnnotation) {
                    idempotentBadge.textContent = 'æœ‰æ³¨è§£';
                    idempotentBadge.className = 'status-badge status-enabled';
                } else {
                    idempotentBadge.textContent = 'æœªé…ç½®';
                    idempotentBadge.className = 'status-badge status-disabled';
                }

                // æ›´æ–°é˜²é‡å¤æäº¤çŠ¶æ€
                const duplicateBadge = document.querySelector(`[data-endpoint-duplicate][data-method="${methodSignature}"]`);
                const hasDuplicateConfig = !!duplicateSubmitConfigs[methodSignature];
                if (hasDuplicateConfig) {
                    duplicateBadge.textContent = 'å·²é…ç½®';
                    duplicateBadge.className = 'status-badge status-enabled';
                } else if (endpoint.hasDuplicateSubmitAnnotation) {
                    duplicateBadge.textContent = 'æœ‰æ³¨è§£';
                    duplicateBadge.className = 'status-badge status-enabled';
                } else {
                    duplicateBadge.textContent = 'æœªé…ç½®';
                    duplicateBadge.className = 'status-badge status-disabled';
                }

                // æ›´æ–°æ•´ä½“çŠ¶æ€
                const statusBadge = document.querySelector(`[data-endpoint-status][data-method="${methodSignature}"]`);
                const hasProtection = hasIdempotentConfig || hasDuplicateConfig || endpoint.hasIdempotentAnnotation || endpoint.hasDuplicateSubmitAnnotation;
                
                if (hasProtection) {
                    statusBadge.textContent = 'å·²ä¿æŠ¤';
                    statusBadge.className = 'status-badge status-enabled';
                } else {
                    statusBadge.textContent = 'æœªä¿æŠ¤';
                    statusBadge.className = 'status-badge status-disabled';
                }

                // æ›´æ–°æŒ‰é’®çŠ¶æ€å’Œæ–‡æœ¬
                const idempotentBtn = document.querySelector(`[data-idempotent-btn][data-method="${methodSignature}"]`);
                const duplicateBtn = document.querySelector(`[data-duplicate-btn][data-method="${methodSignature}"]`);
                
                if (idempotentBtn) {
                    if (hasIdempotentConfig) {
                        idempotentBtn.textContent = 'ç¼–è¾‘å¹‚ç­‰æ€§';
                        idempotentBtn.className = 'btn btn-warning btn-sm';
                    } else {
                        idempotentBtn.textContent = 'é…ç½®å¹‚ç­‰æ€§';
                        idempotentBtn.className = 'btn btn-success btn-sm';
                    }
                }
                
                if (duplicateBtn) {
                    if (hasDuplicateConfig) {
                        duplicateBtn.textContent = 'ç¼–è¾‘é˜²é‡å¤';
                        duplicateBtn.className = 'btn btn-warning btn-sm';
                    } else {
                        duplicateBtn.textContent = 'é…ç½®é˜²é‡å¤';
                        duplicateBtn.className = 'btn btn-info btn-sm';
                    }
                }
            });
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStatistics() {
            const totalEndpoints = endpoints.length;
            
            // è®¡ç®—æœ‰å¹‚ç­‰æ€§æ³¨è§£æˆ–é…ç½®çš„æ¥å£æ•°é‡
            const idempotentCount = endpoints.filter(endpoint => 
                endpoint.hasIdempotentAnnotation || idempotentConfigs[endpoint.methodSignature]
            ).length;
            
            // è®¡ç®—æœ‰é˜²é‡å¤æäº¤æ³¨è§£æˆ–é…ç½®çš„æ¥å£æ•°é‡  
            const duplicateCount = endpoints.filter(endpoint =>
                endpoint.hasDuplicateSubmitAnnotation || duplicateSubmitConfigs[endpoint.methodSignature]
            ).length;
            
            // è®¡ç®—æœªé…ç½®ä¿æŠ¤çš„æ¥å£æ•°é‡
            const unconfiguredCount = endpoints.filter(endpoint => 
                !endpoint.hasIdempotentAnnotation && 
                !endpoint.hasDuplicateSubmitAnnotation &&
                !idempotentConfigs[endpoint.methodSignature] && 
                !duplicateSubmitConfigs[endpoint.methodSignature]
            ).length;

            // æ›´æ–°é¡µé¢æ˜¾ç¤º
            const totalElement = document.querySelector('.stat-card .stat-number');
            if (totalElement) {
                totalElement.textContent = totalEndpoints;
            }
            
            const idempotentElement = document.getElementById('idempotent-count');
            if (idempotentElement) {
                idempotentElement.textContent = idempotentCount;
            }
            
            const duplicateElement = document.getElementById('duplicate-count');
            if (duplicateElement) {
                duplicateElement.textContent = duplicateCount;
            }
            
            const unconfiguredElement = document.getElementById('unconfigured-count');
            if (unconfiguredElement) {
                unconfiguredElement.textContent = unconfiguredCount;
            }
        }

        // æœç´¢æ¥å£
        function searchEndpoints() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            filterAndDisplayEndpoints(keyword);
        }

        // è¿‡æ»¤æ¥å£
        function filterEndpoints() {
            const filterType = document.getElementById('filterType').value;
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            filterAndDisplayEndpoints(keyword, filterType);
        }

        // è¿‡æ»¤å’Œæ˜¾ç¤ºæ¥å£
        function filterAndDisplayEndpoints(keyword = '', filterType = 'all') {
            let visibleCount = 0;
            
            endpoints.forEach(endpoint => {
                const methodSignature = endpoint.methodSignature;
                let shouldShow = true;

                // å…³é”®å­—è¿‡æ»¤
                if (keyword) {
                    const searchText = `${endpoint.methodName || ''} ${endpoint.path || ''} ${endpoint.className || ''} ${endpoint.httpMethod || ''}`.toLowerCase();
                    shouldShow = shouldShow && searchText.includes(keyword);
                }

                // ç±»å‹è¿‡æ»¤
                if (filterType !== 'all') {
                    const hasIdempotentAnnotation = endpoint.hasIdempotentAnnotation || false;
                    const hasDuplicateAnnotation = endpoint.hasDuplicateSubmitAnnotation || false;
                    const hasIdempotentConfig = !!idempotentConfigs[methodSignature];
                    const hasDuplicateConfig = !!duplicateSubmitConfigs[methodSignature];
                    const hasIdempotent = hasIdempotentAnnotation || hasIdempotentConfig;
                    const hasDuplicate = hasDuplicateAnnotation || hasDuplicateConfig;
                    
                    switch (filterType) {
                        case 'å·²é…ç½®å¹‚ç­‰æ€§':
                            shouldShow = shouldShow && hasIdempotent;
                            break;
                        case 'å·²é…ç½®é˜²é‡å¤':
                            shouldShow = shouldShow && hasDuplicate;
                            break;
                        case 'æœªé…ç½®':
                            shouldShow = shouldShow && !hasIdempotent && !hasDuplicate;
                            break;
                    }
                }

                // æ˜¾ç¤º/éšè—å¯¹åº”çš„è¡Œ
                const row = document.querySelector(`[data-method-signature="${methodSignature}"]`);
                if (row) {
                    row.style.display = shouldShow ? 'flex' : 'none';
                    if (shouldShow) visibleCount++;
                }
            });

            // æ˜¾ç¤º/éšè—ç©ºçŠ¶æ€
            const emptyState = document.getElementById('empty-state');
            if (emptyState) {
                emptyState.style.display = visibleCount === 0 ? 'block' : 'none';
            }
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            loadEndpoints(); // è¿™ä¼šé‡æ–°åŠ è½½æ¥å£æ•°æ®å’Œé…ç½®æ•°æ®
            showAlert('æ•°æ®å·²åˆ·æ–°', 'success');
        }

        // æ§åˆ¶å¤±è´¥æ£€æµ‹é€‰é¡¹çš„æ˜¾ç¤º/éšè—
        function toggleFailureOptions() {
            const strategy = document.getElementById('idempotent-failure-detection').value;
            const exceptionsGroup = document.getElementById('failure-exceptions-group');
            const conditionGroup = document.getElementById('failure-condition-group');
            
            // éšè—æ‰€æœ‰é€‰é¡¹
            exceptionsGroup.style.display = 'none';
            conditionGroup.style.display = 'none';
            
            // æ ¹æ®ç­–ç•¥æ˜¾ç¤ºå¯¹åº”é€‰é¡¹
            if (strategy === 'SPECIFIC_EXCEPTIONS') {
                exceptionsGroup.style.display = 'block';
            } else if (strategy === 'CUSTOM_CONDITION') {
                conditionGroup.style.display = 'block';
            }
        }

        // é…ç½®å¹‚ç­‰æ€§
        function configureIdempotent(methodSignature) {
            document.getElementById('idempotent-method-signature').value = methodSignature;
            document.getElementById('idempotent-method-display').value = methodSignature;
            
            const config = idempotentConfigs[methodSignature];
            if (config) {
                document.getElementById('idempotent-timeout').value = config.timeout || 60;
                document.getElementById('idempotent-message').value = config.message || '';
                document.getElementById('idempotent-return-first').checked = config.returnFirstResult !== false;
                document.getElementById('idempotent-allow-retry').checked = config.allowRetryOnFailure !== false;
                document.getElementById('idempotent-failure-detection').value = config.failureDetection || 'ALL';
                document.getElementById('idempotent-failure-exceptions').value = config.failureExceptions || '';
                document.getElementById('idempotent-failure-condition').value = config.failureCondition || '';
                document.getElementById('delete-idempotent-btn').style.display = 'inline-block';
            } else {
                document.getElementById('idempotent-timeout').value = 60;
                document.getElementById('idempotent-message').value = '';
                document.getElementById('idempotent-return-first').checked = true;
                document.getElementById('idempotent-allow-retry').checked = true;
                document.getElementById('idempotent-failure-detection').value = 'ALL';
                document.getElementById('idempotent-failure-exceptions').value = '';
                document.getElementById('idempotent-failure-condition').value = '';
                document.getElementById('delete-idempotent-btn').style.display = 'none';
            }
            
            // æ˜¾ç¤ºå¯¹åº”çš„å¤±è´¥æ£€æµ‹é€‰é¡¹
            toggleFailureOptions();
            
            document.getElementById('idempotentModal').style.display = 'block';
        }

        // é…ç½®é˜²é‡å¤æäº¤
        function configureDuplicateSubmit(methodSignature) {
            document.getElementById('duplicate-method-signature').value = methodSignature;
            document.getElementById('duplicate-method-display').value = methodSignature;
            
            const config = duplicateSubmitConfigs[methodSignature];
            if (config) {
                document.getElementById('duplicate-interval').value = config.interval || 5;
                document.getElementById('duplicate-message').value = config.message || '';
                document.getElementById('duplicate-dimension').value = config.dimension || 'USER_METHOD';
                document.getElementById('delete-duplicate-btn').style.display = 'inline-block';
            } else {
                document.getElementById('duplicate-interval').value = 5;
                document.getElementById('duplicate-message').value = '';
                document.getElementById('duplicate-dimension').value = 'USER_METHOD';
                document.getElementById('delete-duplicate-btn').style.display = 'none';
            }
            
            document.getElementById('duplicateModal').style.display = 'block';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeIdempotentModal() {
            document.getElementById('idempotentModal').style.display = 'none';
        }

        function closeDuplicateModal() {
            document.getElementById('duplicateModal').style.display = 'none';
        }

        // ä¿å­˜å¹‚ç­‰æ€§é…ç½®
        function saveIdempotentConfig() {
            const methodSignature = document.getElementById('idempotent-method-signature').value;
            const config = {
                methodSignature: methodSignature,
                enabled: true,
                timeout: parseInt(document.getElementById('idempotent-timeout').value),
                keyStrategy: "USER_PARAMS", // é»˜è®¤ä½¿ç”¨ç”¨æˆ·ID+å‚æ•°çš„ç­–ç•¥ï¼ˆå¹‚ç­‰æ€§æœ€ä½³å®è·µï¼‰
                returnFirstResult: document.getElementById('idempotent-return-first').checked,
                message: document.getElementById('idempotent-message').value || "è¯·æ±‚æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™å†è¯•",
                allowRetryOnFailure: document.getElementById('idempotent-allow-retry').checked,
                failureDetection: document.getElementById('idempotent-failure-detection').value,
                failureExceptions: document.getElementById('idempotent-failure-exceptions').value,
                failureCondition: document.getElementById('idempotent-failure-condition').value
            };

            fetch('/admin/rate-limiter/api/idempotent/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('å¹‚ç­‰æ€§é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                    closeIdempotentModal();
                    loadConfigurations();
                } else {
                    showAlert('ä¿å­˜å¤±è´¥: ' + data.message, 'error');
                }
            })
            .catch(error => {
                showAlert('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            });
        }

        // ä¿å­˜é˜²é‡å¤æäº¤é…ç½®
        function saveDuplicateConfig() {
            const methodSignature = document.getElementById('duplicate-method-signature').value;
            const config = {
                methodSignature: methodSignature,
                interval: parseInt(document.getElementById('duplicate-interval').value),
                message: document.getElementById('duplicate-message').value,
                dimension: document.getElementById('duplicate-dimension').value
            };

            fetch('/admin/rate-limiter/api/duplicate-submit/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('é˜²é‡å¤æäº¤é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                    closeDuplicateModal();
                    loadConfigurations();
                } else {
                    showAlert('ä¿å­˜å¤±è´¥: ' + data.message, 'error');
                }
            })
            .catch(error => {
                showAlert('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            });
        }

        // åˆ é™¤å¹‚ç­‰æ€§é…ç½®
        function deleteIdempotentConfig() {
            const methodSignature = document.getElementById('idempotent-method-signature').value;
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤å¹‚ç­‰æ€§é…ç½®å—ï¼Ÿ')) return;
            
            fetch('/admin/rate-limiter/api/idempotent/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'methodSignature=' + encodeURIComponent(methodSignature)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('åˆ é™¤æˆåŠŸ', 'success');
                    closeIdempotentModal();
                    loadConfigurations();
                } else {
                    showAlert('åˆ é™¤å¤±è´¥: ' + data.message, 'error');
                }
            });
        }

        // åˆ é™¤é˜²é‡å¤æäº¤é…ç½®
        function deleteDuplicateConfig() {
            const methodSignature = document.getElementById('duplicate-method-signature').value;
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤é˜²é‡å¤æäº¤é…ç½®å—ï¼Ÿ')) return;
            
            fetch('/admin/rate-limiter/api/duplicate-submit/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'methodSignature=' + encodeURIComponent(methodSignature)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('åˆ é™¤æˆåŠŸ', 'success');
                    closeDuplicateModal();
                    loadConfigurations();
                } else {
                    showAlert('åˆ é™¤å¤±è´¥: ' + data.message, 'error');
                }
            });
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type) {
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            
            document.querySelector('.header').insertAdjacentElement('afterend', alert);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }
    </script>
</body>
</html>